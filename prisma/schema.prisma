generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               Int       @id @default(autoincrement()) @map("user_id")
  // supabase OAuth link
  supabaseAuthId   String?   @unique @map("supabase_uid") @db.Uuid
  username         String?   @unique @db.Text
  role             RoleName  @default(REGISTERED)
  email            String    @unique @db.Text
  passwordHash     String?   @map("password_hash") @db.Text
  registrationDate DateTime  @map("registration_date") @db.Date
  updatedDate      DateTime? @map("updated_date") @db.Date
  submissionDate   DateTime? @map("submission_date") @db.Date

  // Verification
  status      UserStatus @default(PENDING) @map("status")
  idNumber    String?    @map("id_number") @db.Text
  idImagePath String?    @map("id_image") @db.Text

  // Foreign Keys (CamelCase in Code -> Snake_case in DB)
  tierId    Int  @map("tier_id")
  collegeId Int? @map("college_id")

  // Relations
  subscriptionTier SubscriptionTier @relation(fields: [tierId], references: [id])
  college          College?         @relation(fields: [collegeId], references: [id])
  documents        Document[]       @relation("UserUploads")
  userBookmarks    UserBookmark[]
  activityLogs     ActivityLog[]

  @@map("users")
}

model SubscriptionTier {
  id                 Int      @id @default(autoincrement()) @map("tier_id")
  tierName           TierName @default(FREE) @map("tier_name")
  dailyDownloadLimit Int?     @map("daily_download_limit")
  dailyCitationLimit Int?     @map("daily_citation_limit")
  maxBookmarks       Int?     @map("max_bookmarks")
  hasAds             Boolean  @map("has_ads")
  hasAiInsights      Boolean  @map("has_ai_insights")
  users              User[]

  @@map("subscription_tiers")
}

model Document {
  id             Int           @id @default(autoincrement()) @map("document_id")
  title          String        @unique @db.Text
  abstract       String        @db.Text
  filePath       String        @map("file_path") @db.Text
  submissionDate DateTime?     @map("submission_date") @db.Date
  datePublished  DateTime?     @map("date_published") @db.Date
  status         DocStatus     @default(PENDING)
  resourceType   ResourceTypes @default(THESIS) @map("resource_type")
  downloadsCount Int           @default(0) @map("downloads_count")
  citationCount  Int           @default(0) @map("citation_count")
  aiSummary      String?       @map("ai_summary") @db.Text

  // File Metadata
  originalFileName String? @map("original_file_name") @db.Text
  fileSize         Int?    @map("file_size")
  mimeType         String? @map("mime_type") @db.Text
  fileHash         String? @map("file_hash") @db.Text

  // Foreign Keys
  uploaderId Int @map("uploader_id")
  courseId   Int @map("course_id")

  // Relations
  uploader User   @relation("UserUploads", fields: [uploaderId], references: [id])
  course   Course @relation(fields: [courseId], references: [id])

  bookmarks      UserBookmark[]
  authors        DocumentAuthor[]
  keywords       DocumentKeyword[]
  activityLogs   ActivityLog[]
  documentChunks DocumentChunk[]

  @@index([title])
  @@map("documents")
}

model UserBookmark {
  userId         Int      @map("user_id")
  documentId     Int      @map("document_id")
  dateBookmarked DateTime @default(now()) @map("date_bookmarked")
  document       Document @relation(fields: [documentId], references: [id])
  user           User     @relation(fields: [userId], references: [id])

  @@id([userId, documentId])
  @@map("user_bookmarks")
}

model DocumentAuthor {
  documentId  Int      @map("document_id")
  authorId    Int      @map("author_id")
  authorOrder Int      @map("author_order")
  author      Author   @relation(fields: [authorId], references: [id])
  document    Document @relation(fields: [documentId], references: [id])

  @@id([documentId, authorId])
  @@map("document_authors")
}

model Author {
  id         Int              @id @default(autoincrement()) @map("author_id")
  fullName   String           @map("full_name")
  email      String?          @unique
  firstName  String           @map("first_name")
  lastName   String           @map("last_name")
  middleName String?          @map("middle_name")
  documents  DocumentAuthor[]

  @@map("authors")
}

model DocumentKeyword {
  documentId Int      @map("document_id")
  keywordId  Int      @map("keyword_id")
  document   Document @relation(fields: [documentId], references: [id])
  keyword    Keyword  @relation(fields: [keywordId], references: [id])

  @@id([documentId, keywordId])
  @@map("document_keywords")
}

model Keyword {
  id          Int               @id @default(autoincrement()) @map("keyword_id")
  keywordText String            @unique @map("keyword_text")
  documents   DocumentKeyword[]

  @@map("keywords")
}

model Course {
  id         Int        @id @default(autoincrement()) @map("course_id")
  courseName String     @map("course_name")
  courseAbbr String     @map("course_abbr")
  collegeId  Int        @map("college_id")
  college    College    @relation(fields: [collegeId], references: [id])
  documents  Document[]

  @@map("courses")
}

model College {
  id          Int      @id @default(autoincrement()) @map("college_id")
  collegeName String   @unique @map("college_name")
  collegeAbbr String   @unique @map("college_abbr")
  courses     Course[]
  users       User[]

  @@map("colleges")
}

model ActivityLog {
  id           BigInt    @id @default(autoincrement()) @map("log_id")
  userId       Int       @map("user_id")
  documentId   Int?      @map("document_id")
  activityType String    @map("activity_type")
  createdAt    DateTime  @default(now()) @map("created_at")
  document     Document? @relation(fields: [documentId], references: [id])
  user         User      @relation(fields: [userId], references: [id])

  @@map("activity_logs")
}

model DocumentChunk {
  id         BigInt @id @default(autoincrement())
  documentId Int    @map("document_id")

  content String @db.Text
  phrase  String @db.Text

  embedding Unsupported("vector(384)")?

  pageStart Int     @map("page_start")
  pageEnd   Int     @map("page_end")
  charStart Int     @map("char_start")
  charEnd   Int     @map("char_end")
  section   String? @db.Text

  document Document @relation(fields: [documentId], references: [id])

  @@map("document_chunks")
}

enum RoleName {
  REGISTERED
  ADMIN
  SUPERADMIN
  OWNER
}

enum UserStatus {
  PENDING
  APPROVED
  DELETED
}

enum TierName {
  FREE
  PAID
}

enum DocStatus {
  PENDING
  APPROVED
  REJECTED
  DELETED
}

enum ResourceTypes {
  THESIS
  CAPSTONE
  DISSERTATION
  ARTICLE
  RESEARCH_PAPER
}
